<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upload Record - Aion Archive</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="ambient" aria-hidden="true"></div>
    <header class="site-header">
      <div class="brand">
        <span class="brand-mark">A</span>
        <span class="brand-text">Aion Archive</span>
      </div>
      <nav class="nav">
        <a href="/home">Home</a>
        <a href="/uploadpdf">Upload</a>
        <a href="/mylibrary">My Library</a>
        <a href="/public-library">Public Library</a>
      </nav>
      <div style="display: flex; gap: 12px; align-items: center;">
        <a class="btn btn-ghost" href="/access">Access Code</a>
        <a class="btn btn-ghost" href="/logout">Log out</a>
      </div>
    </header>

    <main class="auth-page">
      <section class="auth-card reveal" style="--delay: 0.1s">
        <div class="auth-header">
          <p class="eyebrow">Preserve and enrich</p>
          <h1>Upload a new record</h1>
          <p class="lead">Upload PDFs, images, or text files. Metadata is auto-generated and editable.</p>
        </div>
        <form class="auth-panel" method="post" action="/uploadpdf" enctype="multipart/form-data">
          <div class="upload-options">
            <div class="upload-option">
              <label class="upload-box" for="fileInput">
                <input type="file" id="fileInput" name="file" accept=".pdf,.png,.jpg,.jpeg,.txt" style="display: none;" />
                <div class="upload-icon">ðŸ“„</div>
                <div class="upload-text">
                  <div class="upload-title">From File</div>
                  <div class="upload-desc">PDF, PNG, JPG, TXT</div>
                </div>
              </label>
            </div>
            <div class="upload-option">
              <label class="upload-box" for="cameraInput">
                <input type="file" id="cameraInput" name="file" accept="image/*" capture="environment" style="display: none;" />
                <div class="upload-icon">ðŸ“·</div>
                <div class="upload-text">
                  <div class="upload-title">From Camera</div>
                  <div class="upload-desc">Capture document</div>
                </div>
              </label>
            </div>
          </div>

          <div id="selectedFile" class="selected-file" style="display: none; padding: 12px 16px; margin-bottom: 16px; background: rgba(15, 118, 110, 0.1); border-left: 4px solid var(--tide); border-radius: 8px; font-size: 14px; color: var(--tide-dark); font-weight: 500; align-items: center; justify-content: space-between;">
            <span id="selectedFileName"></span>
            <button type="button" onclick="clearUploadFile()" style="background: none; border: none; color: var(--tide-dark); cursor: pointer; font-size: 20px; padding: 0; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(15, 118, 110, 0.2)'" onmouseout="this.style.background='none'">âœ•</button>
          </div>

          <div id="loadingSpinner" style="display: none; text-align: center; padding: 20px; margin: 16px 0;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(15, 118, 110, 0.1); border-top-color: var(--tide); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <p style="margin-top: 12px; color: var(--tide); font-weight: 500;">Analyzing document...</p>
          </div>

          <div style="margin: 16px 0; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: #fff;">
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <button type="button" class="btn btn-ghost" id="genDeviceTokenBtn">Generate device upload token</button>
              <span style="font-size: 0.9rem; color: #334155;">Use this token on the Raspberry Pi to auto-upload scans.</span>
            </div>

            <div id="deviceTokenBox" style="display:none; margin-top:12px;">
              <div style="font-size: 0.85rem; color:#64748b; margin-bottom:6px;">Device Token</div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <code id="deviceTokenValue" style="padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; word-break:break-all;"></code>
                <button type="button" class="btn btn-primary" id="copyDeviceTokenBtn">Copy</button>
              </div>
            </div>

            <!-- ADDED: Pi scan button -->
            <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid #e2e8f0;">
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <button type="button" class="btn btn-primary" id="piScanBtn">Scan using Raspberry Pi</button>
                <span style="font-size: 0.9rem; color: #334155;">Press the Pico button when prompted.</span>
              </div>
              <div id="piScanStatus" style="display:none; margin-top:10px; font-size: 0.9rem; color:#0f766e; font-weight:600;"></div>
            </div>
            <!-- END ADDED -->
          </div>

          <style>
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
          </style>

          <label class="field">
            <span>Title</span>
            <input type="text" name="title" placeholder="Enter document title" required />
          </label>
          <label class="field">
            <span>Authors</span>
            <input type="text" name="authors" placeholder="Comma-separated" required />
          </label>
          <label class="field">
            <span>Tags</span>
            <input type="text" name="tags" placeholder="Comma-separated" required />
          </label>
          <label class="field">
            <span>Date</span>
            <input type="date" name="date" required />
          </label>
          <label class="field" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" name="is_public" value="true" checked />
            <span>Make this document public</span>
          </label>
          <label class="field">
            <span>Language</span>
            <select name="language" style="padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc; font-size: 0.95rem; cursor: pointer; color: var(--ink); font-family: 'Space Grotesk', sans-serif;">
              <option value="eng" selected>English</option>
              <option value="spa">Spanish</option>
              <option value="fra">French</option>
              <option value="deu">German</option>
              <option value="ara">Arabic</option>
              <option value="zho">Chinese</option>
            </select>
          </label>
          <div class="auth-actions">
            <button class="btn btn-primary btn-large" type="submit">
              <span>Upload and extract</span>
            </button>
          </div>
          <p class="auth-note">OCR will extract text from images and scanned PDFs.</p>
        </form>

        <script>
          const fileInput = document.getElementById('fileInput');
          const cameraInput = document.getElementById('cameraInput');
          const selectedFile = document.getElementById('selectedFile');
          const form = document.querySelector('.auth-panel');
          const titleInput = document.querySelector('input[name="title"]');
          const authorsInput = document.querySelector('input[name="authors"]');
          const tagsInput = document.querySelector('input[name="tags"]');
          const dateInput = document.querySelector('input[name="date"]');

          // Set default date to today
          const today = new Date().toISOString().split('T')[0];
          dateInput.value = today;

          authorsInput.addEventListener('input', (e) => {
            const value = e.target.value;
            const updated = value.replace(/\s+and\s+/gi, ', ');
            if (updated !== value) e.target.value = updated;
          });

          async function extractAndAnalyzeFile(file) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            try {
              loadingSpinner.style.display = 'block';
              const formData = new FormData();
              formData.append('file', file);

              const response = await fetch('/api/analyze-file', {
                method: 'POST',
                body: formData
              });

              if (!response.ok) return;

              const data = await response.json();
              if (data.success) {
                if (data.title && !titleInput.value) titleInput.value = data.title;
                if (data.authors && !authorsInput.value) authorsInput.value = data.authors;
                if (data.tags && !tagsInput.value) tagsInput.value = data.tags.join(', ');
              }
            } catch (error) {
              console.error('Error analyzing file:', error);
            } finally {
              loadingSpinner.style.display = 'none';
            }
          }

          fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
              const file = e.target.files[0];
              document.getElementById('selectedFileName').textContent = `ðŸ“„ ${file.name}`;
              selectedFile.style.display = 'flex';
              cameraInput.value = '';
              extractAndAnalyzeFile(file);
            }
          });

          cameraInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
              const file = e.target.files[0];
              document.getElementById('selectedFileName').textContent = `ðŸ“· ${file.name}`;
              selectedFile.style.display = 'flex';
              fileInput.value = '';
              extractAndAnalyzeFile(file);
            }
          });

          function clearUploadFile() {
            fileInput.value = '';
            cameraInput.value = '';
            selectedFile.style.display = 'none';
            document.getElementById('selectedFileName').textContent = '';
          }

          // device token generation + copy
          const genDeviceTokenBtn = document.getElementById("genDeviceTokenBtn");
          const deviceTokenBox = document.getElementById("deviceTokenBox");
          const deviceTokenValue = document.getElementById("deviceTokenValue");
          const copyDeviceTokenBtn = document.getElementById("copyDeviceTokenBtn");

          if (genDeviceTokenBtn) {
            genDeviceTokenBtn.addEventListener("click", async () => {
              try {
                const res = await fetch("/api/device/create-token", { method: "GET" });
                const data = await res.json();
                if (!data.success) {
                  alert(data.message || "Failed to create token.");
                  return;
                }
                deviceTokenValue.textContent = data.token;
                deviceTokenBox.style.display = "block";
              } catch (err) {
                console.error(err);
                alert("Error creating token.");
              }
            });
          }

          if (copyDeviceTokenBtn) {
            copyDeviceTokenBtn.addEventListener("click", async () => {
              const token = (deviceTokenValue.textContent || "").trim();
              if (!token) {
                alert("No token to copy yet.");
                return;
              }
              try {
                await navigator.clipboard.writeText(token);
                alert("Copied token!");
              } catch (err) {
                console.error(err);
                try {
                  const ta = document.createElement('textarea');
                  ta.value = token;
                  document.body.appendChild(ta);
                  ta.select();
                  document.execCommand('copy');
                  document.body.removeChild(ta);
                  alert('Copied token!');
                } catch {
                  alert("Could not copy token. You can still select and copy it manually.");
                }
              }
            });
          }

          // ADDED: Pi scan trigger
          const piScanBtn = document.getElementById('piScanBtn');
          const piScanStatus = document.getElementById('piScanStatus');

          if (piScanBtn) {
            piScanBtn.addEventListener('click', async () => {
              piScanStatus.style.display = 'block';
              piScanStatus.textContent = 'Waiting for Pico button...';

              piScanBtn.disabled = true;

              try {
                // This endpoint must exist in Flask and return JSON { success, doc_id }
                const res = await fetch('/api/pi/scan', { method: 'POST' });

                const data = await res.json();

                if (!data.success) {
                  piScanStatus.textContent = data.message || 'Scan failed.';
                  piScanBtn.disabled = false;
                  return;
                }

                piScanStatus.textContent = 'Scan complete! Redirecting...';

                // Redirect to edit page after creating the record
                if (data.doc_id) {
                  window.location.href = `/file/${data.doc_id}`;
                } else {
                  piScanBtn.disabled = false;
                }
              } catch (err) {
                console.error(err);
                piScanStatus.textContent = 'Error: Could not reach scanner endpoint.';
                piScanBtn.disabled = false;
              }
            });
          }
          // END ADDED

          // Validate at least one file is selected before submission
          form.addEventListener('submit', (e) => {
            if (!fileInput.files.length && !cameraInput.files.length) {
              e.preventDefault();
              alert('Please select a file or capture from camera');
              return false;
            }
          });
        </script>
      </section>
    </main>

    <script src="/static/script.js"></script>
  </body>
</html>
